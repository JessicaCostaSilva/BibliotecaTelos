-- Livros atualmente emprestados (em aberto)
CREATE OR ALTER VIEW dbo.vCurrentLoans AS
SELECT 
    l.loan_id,
    b.book_id, b.title, b.author, b.genre,
    u.user_id, u.name, u.email,
    l.loan_date
FROM dbo.Loans l
JOIN dbo.Books b ON b.book_id = l.book_id
JOIN dbo.Users u ON u.user_id = l.user_id
WHERE l.return_date IS NULL;
GO

-- Histórico de empréstimos
CREATE OR ALTER VIEW dbo.vLoanHistory AS
SELECT 
    l.loan_id,
    b.title,
    u.name AS user_name,
    l.loan_date,
    l.return_date
FROM dbo.Loans l
JOIN dbo.Books b ON b.book_id = l.book_id
JOIN dbo.Users u ON u.user_id = l.user_id;
GO

-- Ranking de usuários por número de empréstimos
CREATE OR ALTER VIEW dbo.vTopUsers AS
SELECT 
    u.user_id,
    u.name,
    COUNT(*) AS total_loans
FROM dbo.Loans l
JOIN dbo.Users u ON u.user_id = l.user_id
GROUP BY u.user_id, u.name;
GO
